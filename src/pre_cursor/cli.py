#!/usr/bin/env python3
"""
Pre-Cursor CLI - Interfaz de l√≠nea de comandos mejorada
======================================================

Interfaz moderna y profesional para Pre-Cursor usando Click.
Proporciona subcomandos, autocompletado y mejor experiencia de usuario.
"""

import click
import json
import yaml
import os
import sys
from pathlib import Path
from rich.console import Console
from rich.table import Table
from rich.panel import Panel
from rich.progress import Progress, SpinnerColumn, TextColumn
from rich.prompt import Prompt, Confirm
from rich import print as rprint

# Importar el generador principal
import sys
import os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', '..'))
from init_project import ProjectGenerator

console = Console()

@click.group()
@click.version_option(version="1.0.0", prog_name="pre-cursor")
@click.option('--verbose', '-v', is_flag=True, help='Activar modo verbose')
@click.option('--config', '-c', type=click.Path(exists=True), help='Archivo de configuraci√≥n')
@click.pass_context
def cli(ctx, verbose, config):
    """
    üöÄ Pre-Cursor: Generador de proyectos optimizado para agentes de IA
    
    Genera estructuras de proyecto completas con metodolog√≠a establecida.
    Soporta Python, FastAPI, TD_MCP, C++, Node.js y m√°s.
    """
    ctx.ensure_object(dict)
    ctx.obj['verbose'] = verbose
    ctx.obj['config'] = config
    
    if verbose:
        console.print("üîß Modo verbose activado", style="blue")

@cli.command()
@click.argument('project_name')
@click.option('--path', '-p', type=click.Path(), help='Ruta donde crear el proyecto')
@click.option('--type', '-t', 'project_type', 
              type=click.Choice([
                  'Python Library', 'Python CLI Tool', 'Python Web App (Flask)',
                  'Python Web App (Django)', 'Python Web App (FastAPI)',
                  'Python Data Science', 'Python ML/AI', 'C++ Project',
                  'Node.js Project', 'TD_MCP Project', 'Otro'
              ]),
              help='Tipo de proyecto')
@click.option('--interactive', '-i', is_flag=True, help='Modo interactivo')
@click.pass_context
def create(ctx, project_name, path, project_type, interactive):
    """
    üéØ Crear un nuevo proyecto
    
    Ejemplos:
    pre-cursor create mi-proyecto
    pre-cursor create mi-api --type "Python Web App (FastAPI)"
    pre-cursor create mi-lib --path /ruta/personalizada
    """
    console.print(f"\nüöÄ Creando proyecto: [bold blue]{project_name}[/bold blue]")
    
    if interactive:
        # Modo interactivo mejorado
        _interactive_create(project_name, path)
    else:
        # Modo directo
        _direct_create(project_name, path, project_type)

@cli.command()
@click.option('--type', '-t', 'project_type',
              type=click.Choice([
                  'Python Library', 'Python CLI Tool', 'Python Web App (Flask)',
                  'Python Web App (Django)', 'Python Web App (FastAPI)',
                  'Python Data Science', 'Python ML/AI', 'C++ Project',
                  'Node.js Project', 'TD_MCP Project', 'Otro'
              ]),
              help='Tipo de proyecto')
@click.option('--output', '-o', type=click.Path(), default='config.json',
              help='Archivo de salida')
@click.option('--format', 'output_format', 
              type=click.Choice(['json', 'yaml']), default='json',
              help='Formato de salida')
def template(project_type, output, output_format):
    """
    üìù Crear plantilla de configuraci√≥n
    
    Genera un archivo de configuraci√≥n template para personalizar.
    
    Ejemplos:
    pre-cursor template --type "Python Library"
    pre-cursor template --type "FastAPI" --format yaml --output mi_config.yaml
    """
    console.print(f"\nüìù Generando plantilla para: [bold blue]{project_type}[/bold blue]")
    
    generator = ProjectGenerator()
    template_data = generator._create_config_template(project_type)
    
    if output_format == 'yaml':
        content = yaml.dump(template_data, default_flow_style=False, sort_keys=False)
    else:
        content = json.dumps(template_data, indent=2, ensure_ascii=False)
    
    with open(output, 'w', encoding='utf-8') as f:
        f.write(content)
    
    console.print(f"‚úÖ Plantilla creada: [bold green]{output}[/bold green]")

@cli.command()
@click.argument('config_file', type=click.Path(exists=True))
@click.option('--dry-run', is_flag=True, help='Simular sin crear archivos')
def generate(config_file, dry_run):
    """
    ‚ö° Generar proyecto desde archivo de configuraci√≥n
    
    Ejemplos:
    pre-cursor generate mi_config.json
    pre-cursor generate config.yaml --dry-run
    """
    console.print(f"\n‚ö° Generando desde: [bold blue]{config_file}[/bold blue]")
    
    if dry_run:
        console.print("üîç Modo dry-run: simulando generaci√≥n...", style="yellow")
    
    generator = ProjectGenerator()
    
    try:
        if config_file.endswith('.yaml') or config_file.endswith('.yml'):
            with open(config_file, 'r', encoding='utf-8') as f:
                config_data = yaml.safe_load(f)
        else:
            with open(config_file, 'r', encoding='utf-8') as f:
                config_data = json.load(f)
        
        if dry_run:
            _show_config_preview(config_data)
        else:
            generator.generate_project_from_config(config_data)
            console.print("‚úÖ Proyecto generado exitosamente!", style="green")
            
    except Exception as e:
        console.print(f"‚ùå Error: {e}", style="red")
        sys.exit(1)

@cli.command()
def list_types():
    """
    üìã Listar tipos de proyecto disponibles
    """
    console.print("\nüìã Tipos de proyecto disponibles:")
    
    table = Table(show_header=True, header_style="bold blue")
    table.add_column("Tipo", style="cyan")
    table.add_column("Descripci√≥n", style="white")
    table.add_column("Tecnolog√≠as", style="green")
    
    types_info = {
        "Python Library": ("Librer√≠as Python est√°ndar", "Python, pytest, black"),
        "Python CLI Tool": ("Herramientas de l√≠nea de comandos", "Python, Click, argparse"),
        "Python Web App (Flask)": ("Aplicaciones web con Flask", "Python, Flask, SQLAlchemy"),
        "Python Web App (Django)": ("Aplicaciones web con Django", "Python, Django, PostgreSQL"),
        "Python Web App (FastAPI)": ("Aplicaciones web con FastAPI", "Python, FastAPI, Pydantic"),
        "Python Data Science": ("Proyectos de ciencia de datos", "Python, pandas, numpy, matplotlib"),
        "Python ML/AI": ("Proyectos de machine learning", "Python, scikit-learn, tensorflow"),
        "C++ Project": ("Proyectos en C++", "C++, CMake, Google Test"),
        "Node.js Project": ("Proyectos en Node.js", "Node.js, npm, Jest"),
        "TD_MCP Project": ("Proyectos MCP para TouchDesigner", "Python, MCP, TouchEngine SDK"),
        "Otro": ("Configuraci√≥n personalizada", "Personalizable")
    }
    
    for project_type, (description, technologies) in types_info.items():
        table.add_row(project_type, description, technologies)
    
    console.print(table)

@cli.command()
@click.option('--examples', is_flag=True, help='Mostrar ejemplos de uso')
def info(examples):
    """
    ‚ÑπÔ∏è Informaci√≥n sobre Pre-Cursor
    """
    console.print(Panel.fit(
        "[bold blue]üöÄ Pre-Cursor v1.0.0[/bold blue]\n\n"
        "Generador de proyectos optimizado para agentes de IA\n"
        "Crea estructuras completas con metodolog√≠a establecida\n\n"
        "[bold green]Caracter√≠sticas:[/bold green]\n"
        "‚Ä¢ Soporte para m√∫ltiples lenguajes y frameworks\n"
        "‚Ä¢ Plantillas profesionales y documentaci√≥n completa\n"
        "‚Ä¢ Integraci√≥n con Git y herramientas de desarrollo\n"
        "‚Ä¢ Optimizado para trabajo con agentes de IA\n\n"
        "[bold yellow]Autor:[/bold yellow] Assiz Alcaraz Baxter\n"
        "[bold yellow]Licencia:[/bold yellow] MIT",
        title="Informaci√≥n del Proyecto"
    ))
    
    if examples:
        console.print("\nüìö Ejemplos de uso:")
        console.print("‚Ä¢ pre-cursor create mi-proyecto")
        console.print("‚Ä¢ pre-cursor create mi-api --type 'Python Web App (FastAPI)'")
        console.print("‚Ä¢ pre-cursor template --type 'Python Library'")
        console.print("‚Ä¢ pre-cursor generate mi_config.json")

def _interactive_create(project_name, path):
    """Modo interactivo mejorado con Rich."""
    console.print("\nüéØ Modo interactivo - Configuraci√≥n del proyecto")
    
    # Seleccionar tipo de proyecto
    project_types = [
        "Python Library", "Python CLI Tool", "Python Web App (Flask)",
        "Python Web App (Django)", "Python Web App (FastAPI)",
        "Python Data Science", "Python ML/AI", "C++ Project",
        "Node.js Project", "TD_MCP Project", "Otro"
    ]
    
    console.print("\nüìã Selecciona el tipo de proyecto:")
    for i, ptype in enumerate(project_types, 1):
        console.print(f"  {i}. {ptype}")
    
    choice = Prompt.ask("Tipo de proyecto", default="1")
    try:
        project_type = project_types[int(choice) - 1]
    except (ValueError, IndexError):
        project_type = project_types[0]
    
    # Obtener informaci√≥n adicional
    description = Prompt.ask("Descripci√≥n del proyecto", default="Proyecto generado con Pre-Cursor")
    author = Prompt.ask("Autor", default="Tu Nombre")
    email = Prompt.ask("Email", default="tu@email.com")
    
    # Confirmar creaci√≥n
    if Confirm.ask(f"\n¬øCrear proyecto '{project_name}' de tipo '{project_type}'?"):
        with Progress(
            SpinnerColumn(),
            TextColumn("[progress.description]{task.description}"),
            console=console,
        ) as progress:
            task = progress.add_task("Generando proyecto...", total=None)
            
            generator = ProjectGenerator()
            # Aqu√≠ ir√≠a la l√≥gica de generaci√≥n
            progress.update(task, description="‚úÖ Proyecto generado!")
        
        console.print(f"üéâ Proyecto '{project_name}' creado exitosamente!", style="green")
    else:
        console.print("‚ùå Operaci√≥n cancelada", style="red")

def _direct_create(project_name, path, project_type):
    """Modo directo simplificado."""
    generator = ProjectGenerator()
    
    with Progress(
        SpinnerColumn(),
        TextColumn("[progress.description]{task.description}"),
        console=console,
    ) as progress:
        task = progress.add_task("Generando proyecto...", total=None)
        
        # Aqu√≠ ir√≠a la l√≥gica de generaci√≥n directa
        progress.update(task, description="‚úÖ Proyecto generado!")
    
    console.print(f"üéâ Proyecto '{project_name}' creado exitosamente!", style="green")

def _show_config_preview(config_data):
    """Mostrar preview de la configuraci√≥n."""
    console.print("\nüìã Preview de configuraci√≥n:")
    
    table = Table(show_header=True, header_style="bold blue")
    table.add_column("Campo", style="cyan")
    table.add_column("Valor", style="white")
    
    for key, value in config_data.items():
        if isinstance(value, (dict, list)):
            value = str(value)[:50] + "..." if len(str(value)) > 50 else str(value)
        table.add_row(key, str(value))
    
    console.print(table)

if __name__ == '__main__':
    cli()
